<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.5.1/leaflet.css" />
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.hexbin.v0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.5.1/leaflet-src.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/colorbrewer@1.1.0/index.min.js"></script>
    <script type="text/javascript" src="leaflet.hexbin-layer.js"></script>

    <style>
        #map {
            min-height: 100%;
            height: 100vh;
            width: 87vw;
            z-index: 0
        }
    </style>

</head>

<!-- Title -->
<h1 align="center" style="font-family: 'Cabin Sketch', cursive;">
    CREATE YOUR OWN FORMULA</h1>

<!-- Parameters section starts -->
<div class="col-md-9">
    <div class="component-box">
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
            <!-- V variable section starts -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingOne">
                    <h4 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Calculate V variable
                        </a>
                    </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                    <div class="panel-body">
                        <p>description variable V</p>
                        <div class="form-group">
                            <label for="regular1" class="control-label">
                                <strong>Weight of Variable 'l
                                    <sub>i</sub>':</strong> Length of sub-section i (in kilometers)</label>
                            <select id="select-l-V" class="form-control">
                                <option>0</option>
                                <option>0.2</option>
                                <option>0.4</option>
                                <option>0.6</option>
                                <option>0.8</option>
                                <option>1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regular1" class="control-label">
                                <strong>Weight of Variable 'v
                                    <sub>i</sub>':</strong> The volume of buses in sub-section i at peak time</label>
                            <select id="select-v-V" class="form-control">
                                <option>0</option>
                                <option>0.2</option>
                                <option>0.4</option>
                                <option>0.6</option>
                                <option>0.8</option>
                                <option>1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regular1" class="control-label">
                                <strong>Weight of Variable 'L':</strong> Total length (in kilometers) - sum of all l
                                <sub>i</sub>
                            </label>
                            <select id="select-L-V" class="form-control">
                                <option>0</option>
                                <option>0.2</option>
                                <option>0.4</option>
                                <option>0.6</option>
                                <option>0.8</option>
                                <option>1</option>
                            </select>
                        </div>
                        <button id="send_V_data" class="btn btn-sm pmd-btn-raised pmd-ripple-effect btn-primary" type="button">Submit</button>
                    </div>
                </div>
            </div>
            <!-- V variable section ends -->

            <!-- P variable section starts -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingTwo">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false"
                            aria-controls="collapseTwo">
                            Calculate P variable
                        </a>
                    </h4>
                </div>
                <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                    <div class="panel-body">
                        <p>description variable P</p>
                        <div class="form-group">
                            <label for="regular1" class="control-label">
                                <strong>Weight of Variable 'l
                                    <sub>i</sub>':</strong> Length of sub-section i (in kilometers)</label>
                            <select id="select-l-P" class="form-control">
                                <option>0</option>
                                <option>0.2</option>
                                <option>0.4</option>
                                <option>0.6</option>
                                <option>0.8</option>
                                <option>1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regular1" class="control-label">
                                <strong>Weight of Variable 'p
                                    <sub>i</sub>':</strong> The number of passengers continuing in a sub-section i at peak time</label>
                            <select id="select-p-P" class="form-control">
                                <option>0</option>
                                <option>0.2</option>
                                <option>0.4</option>
                                <option>0.6</option>
                                <option>0.8</option>
                                <option>1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regular1" class="control-label">
                                <strong>Weight of Variable 'L':</strong> Total length (in kilometers) - sum of all l
                                <sub>i</sub>
                            </label>
                            <select id="select-L-P" class="form-control">
                                <option>0</option>
                                <option>0.2</option>
                                <option>0.4</option>
                                <option>0.6</option>
                                <option>0.8</option>
                                <option>1</option>
                            </select>
                        </div>
                        <button id="send_P_data" class="btn btn-sm pmd-btn-raised pmd-ripple-effect btn-primary" type="button">Submit</button>
                    </div>
                </div>
            </div>
            <!-- P variable section ends -->
        </div>
    </div>
</div>
<!-- Parameters section ends -->

<!-- Map section starts -->
<div class="col-md-12">
    <div id="map"></div>

    <!-- Script starts -->
    <script>

        //Create a map
        var map = L.map('map').setView([32.092739, 34.770454], 13);
        map.setMaxBounds(map.getBounds());
        mapLink =
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; ' + mapLink + ' Contributors',
                maxZoom: 18,
            }).addTo(map);

        map._initPathRoot()

        var svg = d3.select("#map").select("svg"),
            g = svg.append("g");

        //Enable route marking on the map
        map.on('click', addMarker);

        var markers = [];
        var markersLayer = new L.LayerGroup();
        var linesLayer = new L.LayerGroup();

        //Add a point on the map
        function addMarker(e) {
            var newMarker = new L.circleMarker(e.latlng, { radius: 6 }).addTo(markersLayer);
            markersLayer.addTo(map);
            markers.push([e.latlng.lat, e.latlng.lng]);
            if (markers.length > 1) {
                var polyline = new L.Polyline(markers, {
                    color: 'red',
                    weight: 2.5,
                    opacity: 0.5,
                    smoothFactor: 1
                });
                polyline.addTo(linesLayer);
                linesLayer.addTo(map);
            }
        }

        //Clear all points from the map
        function clearData() {
            markersLayer.clearLayers();
            linesLayer.clearLayers();
            markers = [];
        }

        //Prepare the request and send it to the DP
        function onSubmitV(e) {
            if (markers.length < 2) {
                alert("Please mark a rout on the map below");
            }
            else {
                var l = document.getElementById("select-l-V");
                var selected_l = l.options[l.selectedIndex].value;
                var v = document.getElementById("select-v-V");
                var selected_v = v.options[v.selectedIndex].value;
                var L = document.getElementById("select-L-V");
                var selected_L = L.options[L.selectedIndex].value;
                let latlng = markers.map(function (x) {
                    return [x['lat'], x['lng']]
                })
                axios.post('/v_data', [markers, selected_l, selected_v, selected_L]).then(function (response) {
                    var vArray = response.data.data.v,
                        sections = response.data.data.sections,
                        stops = response.data.data.stops;
                    uploud_viz(vArray, sections, stops);
                })
            }
        }

        //Visualization presentation
        function uploud_viz(vArray, sections, stations) {
            console.log(vArray)
            console.log(sections)
            console.log(stations)
            clearData();
            var max = vArray[0],
                min = 0,
                classes = 5,
                scheme = colorbrewer["RdYlGn"][classes];

            max = Math.max(...vArray);

            var scale = d3.scale.quantize()
                .domain([max, 0])
                .range(d3.range(classes));

            for (var i = 0; i < sections.length; i++) {
                var section = sections[i],
                    v = vArray[i];
                var latlngs = section.map(point => [point[0], point[1]])
                var polyline = L.polyline(latlngs, { color: scheme[scale(v)], smoothFactor: 1, opacity: 1 }).addTo(map);
            }

            for (var i = 0; i < stations.length; i++) {
                var station = stations[i]
                var newMarker = new L.circleMarker([station[0], station[1]], { radius: 6 }).addTo(markersLayer);
                markersLayer.addTo(map);
            }

        }

        //Link button to function
        document.getElementById('send_V_data').onclick = onSubmitV;
        document.getElementById('send_P_data').onclick = onSubmitV;

    </script>
    <!-- Script ends -->
</div>
<!-- Map section ends -->